<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>CM/TP Séance 8 - Vues synchronisées, dashboard, Leaflet, Plot et d3.js</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="TP-seance8_files/libs/clipboard/clipboard.min.js"></script>
<script src="TP-seance8_files/libs/quarto-html/quarto.js"></script>
<script src="TP-seance8_files/libs/quarto-html/popper.min.js"></script>
<script src="TP-seance8_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="TP-seance8_files/libs/quarto-html/anchor.min.js"></script>
<link href="TP-seance8_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="TP-seance8_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="TP-seance8_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="TP-seance8_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="TP-seance8_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<link rel="stylesheet" href="./css/tps.css">
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"></script>
<script src="./js/tp-seance8.js"></script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CM/TP Séance 8 - Vues synchronisées, dashboard, Leaflet, Plot et d3.js</h1>
<p class="subtitle lead">BUT Science des données - 3ème année - Université Grenoble Alpes</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="objectifs-de-la-séance" class="level2">
<h2 class="anchored" data-anchor-id="objectifs-de-la-séance">Objectifs de la séance</h2>
<p>Cette séance s’inscrit dans la suite du TP n°8 et a pour objectifs de :</p>
<ul>
<li>continuer à se familiariser avec la création de pages HTML contenant des visualisations de données interactives,</li>
<li>mettre à jour un composant HTML ou un graphique réalisé avec Plot en fonction d’une action de l’utilisateur (clic, survol, etc.),</li>
<li>découvrir D3.js,</li>
</ul>
<p>Nous utiliserons dans cette séance les <a href="https://data.metropolegrenoble.fr/ckan/dataset/statistiques-des-bibliotheques-de-grenoble">statistiques des bibliothèques de Grenoble</a>.</p>
</section>
<section id="vues-synchronisées" class="level2">
<h2 class="anchored" data-anchor-id="vues-synchronisées">Vues synchronisées</h2>
<p>En visualisation de données interactives, il est souvent utile de pouvoir synchroniser plusieurs vues (ou plusieurs composants) entre elles. Cela implique que les données affichées dans les différents composants soient les mêmes et que les interactions dans un composant soient répercutées dans les autres composants.</p>
<p>Par exemple, si vous cliquez sur la barre correspondant à une année dans un histogramme, les données affichées dans un graphique en courbes doivent être celles de l’année sélectionnée ; si l’on sélectionne plusieurs entités sur une carte, les données correspondantes affichées dans un histogramme vont être mises en évidence ; etc.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./img/tp8-regioviz.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Les éléments sélectionnés sur la carte sont mis en valeur sur l’histogramme. Source : <a href="https://riatelab.github.io/regioviz/app/">https://riatelab.github.io/regioviz/app/</a></figcaption>
</figure>
</div>
</section>
<section id="différences-avec-observable" class="level2">
<h2 class="anchored" data-anchor-id="différences-avec-observable">Différences avec Observable</h2>
<p>Vous avez vu comment réaliser des graphiques en fonction d’une valeur sélectionnée par exemple dans un menu déroulant lors des précédents TP. Cela était particulièrement facile à réaliser avec Observable puisque les cellules sont réévaluées automatiquement lors du changement de valeur d’une variable.</p>
<p>Dans une page Web classique, cela n’est pas le cas (il existe toutefois de nombreuses bibliothèques, telles que React.js, Vue.js, Solid.js, etc., qui permettent d’obtenir un comportement réactif similaire).</p>
<p>Par exemple, si nous disposons d’un menu déroulant permettant de sélectionner une année, il va être nécessaire d’écouter manuellement le changement de valeur de ce menu et de mettre à jour les graphiques en conséquence :</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;select</span> <span class="er">id</span><span class="ot">=</span><span class="st">"select-year"</span><span class="kw">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;option</span> <span class="er">value</span><span class="ot">=</span><span class="st">"2019"</span><span class="kw">&gt;</span>2019<span class="kw">&lt;/option&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;option</span> <span class="er">value</span><span class="ot">=</span><span class="st">"2020"</span><span class="kw">&gt;</span>2020<span class="kw">&lt;/option&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;option</span> <span class="er">value</span><span class="ot">=</span><span class="st">"2021"</span><span class="kw">&gt;</span>2021<span class="kw">&lt;/option&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/select&gt;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">"container-viz"</span><span class="kw">&gt;&lt;/div&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>On obtient un menu déroulant permettant de sélectionner une année :</p>
<select id="select-year"> <option value="2019">2019</option> <option value="2020">2020</option> <option value="2021">2021</option> </select>
<p>
<br>
</p>
<div id="container-viz">

</div>
<p><br></p>
<p>Il est ensuite nécessaire de récupérer le menu déroulant, d’écouter le changement de valeur de celui-ci et de mettre à jour les graphiques en conséquence :</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Un jeu de données d'exemple</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dataset <span class="op">=</span> [</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'apple'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2019</span> }<span class="op">,</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'apple'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2020</span> }<span class="op">,</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'apple'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">15</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2021</span> }<span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'banana'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2019</span> }<span class="op">,</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'banana'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2020</span> }<span class="op">,</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'banana'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">8</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2021</span> }<span class="op">,</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'orange'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2019</span> }<span class="op">,</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'orange'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2020</span> }<span class="op">,</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  { <span class="dt">fruit</span><span class="op">:</span> <span class="st">'orange'</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span> <span class="dt">year</span><span class="op">:</span> <span class="dv">2021</span> }<span class="op">,</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Une fonction qui crée le diagramme en barre pour une année donnée</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createViz</span>(year) {</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Filtrer les données pour l'année sélectionnée</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> dataset<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">year</span> <span class="op">===</span> year)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Créer le diagramme en barre avec Plot</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">barY</span>(data<span class="op">,</span> { <span class="dt">x</span><span class="op">:</span> <span class="st">"fruit"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"value"</span><span class="op">,</span> <span class="dt">fill</span><span class="op">:</span> <span class="st">"fruit"</span> })<span class="op">,</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">frame</span>()</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">// On attend le chargement de la page pour exécuter le code</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">'DOMContentLoaded'</span><span class="op">,</span> <span class="kw">async</span> <span class="kw">function</span> () {</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// On récupère les éléments du DOM</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> selectYear <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"select-year"</span>)<span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> vizContainer <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"container-viz"</span>)<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">// On créé le graphique pour l'année 2019</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  vizContainer<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="fu">createViz</span>(<span class="dv">2019</span>)<span class="op">.</span><span class="at">outerHTML</span><span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// On écoute l'événement "change" sur le select et on définit une fonction qui sera</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">// exécutée quand l'événement est déclenché</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  selectYear<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">"change"</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">// L'année sélectionnée (attention, c'est une chaîne de caractères)</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// donc on le convertit en nombre avec '+'</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> year <span class="op">=</span> <span class="op">+</span><span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span><span class="op">;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mettre à jour le graphique</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    vizContainer<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="fu">createViz</span>(year)<span class="op">.</span><span class="at">outerHTML</span><span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>C’est cette logique (définir un comportement à adopter lorsqu’un événement est déclenché et mettre à jour les composants existants) que nous allons utiliser pour synchroniser plusieurs composants entre eux.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>À titre de comparaison, le même comportement, dans Observable, en bénéficiant de la réactivité des cellules : <a href="https://observablehq.com/@sd-progwebdataviz/exemple-a-titre-de-comparaison-pour-le-tp8">ici</a>.</p>
</div>
</div>
</section>
<section id="exercice---création-dun-tableau-de-bord" class="level2">
<h2 class="anchored" data-anchor-id="exercice---création-dun-tableau-de-bord">Exercice - Création d’un “tableau de bord”</h2>
<p>Nous allons maintenant créer un tableau de bord assez simple permettant de visualiser les <a href="https://data.metropolegrenoble.fr/ckan/dataset/statistiques-des-bibliotheques-de-grenoble">statistiques des bibliothèques de Grenoble</a>.</p>
<p>Ce jeu de données contient plusieurs statistiques :</p>
<ul>
<li>Nombre de prêts annuels de 2008 jusqu’à 2016</li>
<li>Nombre d’inscrits de 2008 jusqu’à 2016</li>
<li>Nombre d’emprunteurs de 2008 jusqu’à 2016</li>
<li>Nombre de visiteurs de 2008 jusqu’à 2016</li>
</ul>
<p>Le tableau de bord sera composé de plusieurs composants :</p>
<ul>
<li>une carte Leaflet affichant l’emplacement des bibliothèques ainsi que leur nom lors du survol du curseur,</li>
<li>un graphique en courbes affichant le nombre global (c’est-à-dire de toutes les bibliothèques) de prêts annuels en fonction de l’année,</li>
<li>un graphique en courbes affichant le nombre global d’inscrits en fonction de l’année,</li>
<li>un graphique en courbes affichant le nombre global d’emprunteurs en fonction de l’année,</li>
<li>un graphique en courbes affichant le nombre global de visiteurs en fonction de l’année.</li>
</ul>
<p>Lors du clic sur une bibliothèque sur la carte, ou lors de la sélection d’une bibliothèque spécifique dans le composant <code>&lt;select&gt;</code>, les graphiques doivent être mis à jour pour afficher les données de la bibliothèque sélectionnée plutôt que les données globales.</p>
<p>Par ailleurs, si la bibliothèque a été sélectionnée via la carte, l’en-tête du composant <code>&lt;select&gt;</code> doit être mis à jour pour afficher le nom de la bibliothèque sélectionnée.</p>
<p>Les principales étapes de la création du tableau de bord sont détaillées ci-dessous.</p>
<section id="structure-du-document-html" class="level3">
<h3 class="anchored" data-anchor-id="structure-du-document-html">Structure du document HTML</h3>
<p>Vous devez créer un nouveau document HTML (par exemple <code>index.html</code>) et y ajouter :</p>
<ul>
<li>l’import du fichier CSS de leaflet :</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;link</span> <span class="er">rel</span><span class="ot">=</span><span class="st">"stylesheet"</span> <span class="er">href</span><span class="ot">=</span><span class="st">"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    integrity=</span><span class="st">"sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ot">    crossorigin=</span><span class="st">""</span><span class="kw">/&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>l’import du fichier JS de leaflet :</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ot">      integrity=</span><span class="st">"sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ot">      crossorigin=</span><span class="st">""</span><span class="kw">&gt;&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>l’import du fichier JS de D3.js :</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">"https://cdn.jsdelivr.net/npm/d3@7"</span><span class="kw">&gt;&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>l’import du fichier JS de Plot :</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">"https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6"</span><span class="kw">&gt;&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>par ailleurs, vous aurez besoin d’inclure le fichier JS qui contiendra votre code JavaScript :</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">"index.js"</span><span class="kw">&gt;&lt;/script&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>enfin, vous aurez besoin d’écrire des règles CSS pour agencer les différents éléments de votre page, soit dans un fichier CSS externe, soit dans une balise <code>&lt;style&gt;</code> située elle aussi dans le <code>&lt;head&gt;</code> de votre document HTML :</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;style&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Vos règles de style ici */</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/style&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="chargement-des-données" class="level3">
<h3 class="anchored" data-anchor-id="chargement-des-données">Chargement des données</h3>
<p>Le jeu de données est fourni sous forme de plusieurs fichiers (code + nom des bibliothèques, nombre de prêts, nombre d’inscrits, nombre d’emprunteurs, nombre de visiteurs). J’ai rassemblé ces jeux de données sous forme d’un seul fichier GeoJSON qu’il est possible de récupérer à l’URL suivante : <a href="https://gist.githubusercontent.com/mthh/ff8f4bcacf10a0afe6d1a19556b5cfe7/raw/1f246583a8de3232e6859854ac3315af457626da/BIBLIOTHEQUES_VDG.geojson">https://gist.githubusercontent.com/mthh/ff8f4bcacf10a0afe6d1a19556b5cfe7/raw/1f246583a8de3232e6859854ac3315af457626da/BIBLIOTHEQUES_VDG.geojson</a>.</p>
<p>Il y a une entrée par bibliothèque et chaque entrée contient, en plus de la géométrie, les informations suivantes :</p>
<ul>
<li>Code de la bibliothèque,</li>
<li>Nom de la bibliothèque,</li>
<li>Nombre de prêts annuels de 2008 jusqu’à 2016</li>
<li>Nombre d’inscrits de 2008 jusqu’à 2016</li>
<li>Nombre d’emprunteurs de 2008 jusqu’à 2016</li>
<li>Nombre de visiteurs de 2008 jusqu’à 2016</li>
</ul>
<p>Comme précédemment, nous utilisons la fonction <code>fetch</code> pour récupérer les données :</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Récupération des données (dans une fonction asynchrone car on utilise "await")</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> resp <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(<span class="st">'https://gist.githubusercontent.com/mthh/ff8f4bcacf10a0afe6d1a19556b5cfe7/raw/1f246583a8de3232e6859854ac3315af457626da/BIBLIOTHEQUES_VDG.geojson'</span>)<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> resp<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="création-de-la-carte-leaflet" class="level3">
<h3 class="anchored" data-anchor-id="création-de-la-carte-leaflet">Création de la carte Leaflet</h3>
<p>Sur la base des connaissances acquises dans le TP précédent, vous devez créer une conteneur pour votre carte Leaflet dans le fichier HTML et écrire le code JavaScript permettant de l’instancier et d’afficher les bibliothèques de Grenoble. Lors du survol sur un marqueur de bibliothèque, le nom de la bibliothèque doit être affiché dans une popup.</p>
</section>
<section id="création-dun-élément-select-pour-sélectionner-une-bibliothèque" class="level3">
<h3 class="anchored" data-anchor-id="création-dun-élément-select-pour-sélectionner-une-bibliothèque">Création d’un élément <code>&lt;select&gt;</code> pour sélectionner une bibliothèque</h3>
<p>Ajout de l’élément dans le document HTML :</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;select</span> <span class="er">id</span><span class="ot">=</span><span class="st">"select-bib"</span><span class="kw">&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/select&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Remplissage de l’élément avec les noms des bibliothèques :</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> selectBib <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">"select-bib"</span>)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">// On ajoute une première entrée qui correspond à quand aucune bibliothèque n'est sélectionnée</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> bibs <span class="op">=</span> <span class="op">...</span> <span class="co">// Un tableau contenant les noms des bibliothèques </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ids <span class="op">=</span> <span class="op">...</span> <span class="co">// Un tableau contenant les identifiants des bibliothèques</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">// On itère sur les bibliothèques pour ajouter une entrée par bibliothèque</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">// (on affiche le nom complet de la bibliothèque et on utilise son code dans le champ "value")</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> bibs<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) { <span class="co">// On peut aussi utiliser bibs.forEach((bib, i) =&gt; { ... })</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> option <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">"option"</span>)<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  option<span class="op">.</span><span class="at">text</span> <span class="op">=</span> bibs[i]<span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  option<span class="op">.</span><span class="at">value</span> <span class="op">=</span> ids[i]<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  selectBib<span class="op">.</span><span class="fu">appendChild</span>(option)<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="création-des-graphiques" class="level3">
<h3 class="anchored" data-anchor-id="création-des-graphiques">Création des graphiques</h3>
<p>Vous devez créer 4 graphiques en lignes brisées affichant les données globales (c’est-à-dire de toutes les bibliothèques) de prêts, d’inscrits, d’emprunteurs et de visiteurs en fonction de l’année.</p>
<p>Créez une fonction, responsable de la création d’un graphique, qui prend en paramètre le nom de la bibliothèque à afficher (ou <code>null</code> si on souhaite afficher les données globales) et qui retourne un graphique réalisé avec Plot).</p>
<p>Comme souvent, il va être nécessaire de transformer les données en fonction du type de graphique à réaliser et pour les adapter au format attendu par Plot.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript code-with-copy"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Exemple de fonction</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">makePlotInscrits</span>(dataset<span class="op">,</span> bibliotheque) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>bibliotheque) {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dataInscrits <span class="op">=</span> <span class="op">...</span> <span class="co">// On prépare les données pour l'ensemble des bibliothèques</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// On retourne le graphique</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dataInscrits <span class="op">=</span> <span class="op">...</span> <span class="co">// On prépare les données pour la bibliothèque sélectionnée</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// On retourne le graphique</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Référez-vous au premier extrait de code de ce TP pour voir comment mettre à jour le contenu d’un élément HTML avec le contenu d’un graphique Plot.</p>
</section>
<section id="agencement-des-éléments-dans-la-page" class="level3">
<h3 class="anchored" data-anchor-id="agencement-des-éléments-dans-la-page">Agencement des éléments dans la page</h3>
<p>Afin d’agencer les différents éléments dans une page HTML, il est nécessaire d’avoir recours au langage CSS.</p>
<p>En effet, vous avez probablement remarqué que lorsque vous créez un élément <code>&lt;div&gt;</code> dans une page HTML, celui-ci est affiché sur une ligne différente (<em>une nouvelle ligne</em>) des autres éléments.</p>
<p>Il est toutefois souvent souhaitable d’afficher plusieurs éléments HTML “en bloc” (div, section, etc.) sur une même ligne.</p>
<p>Ceci est possible de plusieurs manières :</p>
<ul>
<li>en utilisant la propriété CSS <code>display: flex</code> et la propriété <code>flex-direction: row</code> sur le conteneur des éléments à afficher sur la même ligne (il est ensuite nécessaire de définir une largeur pour chacun des éléments).</li>
<li>en utilisant la propriété CSS <code>display: grid</code> sur le conteneur des éléments à afficher sur la même ligne (il est ensuite nécessaire de définir une largeur pour chacun des éléments),</li>
<li>en utilisant la propriété CSS <code>display: inline-block</code> sur les éléments à afficher sur la même ligne,</li>
<li>en utilisant la propriété CSS <code>float</code> (avec la valeur <code>left</code> ou <code>right</code>) sur les éléments à afficher sur la même ligne.</li>
</ul>
<p>Les solutions à privilégier sont <code>display: flex</code> et <code>display: grid</code>. Cf. exemple vu en cours.</p>
<p>D’autres exemples traitant de ce sujet :</p>
<ul>
<li>Sur Mozilla Developper Network : <a href="https://developer.mozilla.org/fr/docs/Web/CSS/CSS_flexible_box_layout/Basic_concepts_of_flexbox">Basic_concepts_of_flexbox</a> et <a href="https://developer.mozilla.org/fr/docs/Web/CSS/CSS_Grid_Layout/Basic_Concepts_of_Grid_Layout">Basic_Concepts_of_Grid_Layout</a>,</li>
<li>Sur W3schools <a href="https://www.w3schools.com/howto/howto_css_two_columns.asp">How To - Two Column Layout</a>, <a href="https://www.w3schools.com/howto/howto_css_three_columns.asp">How To - Three Column Layout</a> et <a href="https://www.w3schools.com/howto/howto_css_four_columns.asp">How To - Four Column Layout</a>,</li>
<li><a href="https://dev.to/dawnind/3-ways-to-display-two-divs-side-by-side-3d8b">https://dev.to/dawnind/3-ways-to-display-two-divs-side-by-side-3d8b</a>.</li>
</ul>
</section>
<section id="pour-info-création-remplacement-des-graphiques-vs.-mise-à-jour-des-graphiques" class="level3">
<h3 class="anchored" data-anchor-id="pour-info-création-remplacement-des-graphiques-vs.-mise-à-jour-des-graphiques">Pour info : Création / remplacement des graphiques vs.&nbsp;mise à jour des graphiques</h3>
<p>Dans les exemples précédents, nous avons vu comment créer des graphiques avec Plot et comment remplacer les graphiques existants par de nouveaux graphiques.</p>
<p>Cette technique est suffisante, notamment lorsque la création des graphiques est rapide. C’est d’ailleurs la technique qui est conseillée dans la documentation de Plot (et qui est utilisée dans Observable puisque les cellules sont réévaluées automatiquement lors du changement de valeur d’une variable).</p>
<p>Dans certains cas, il peut être intéressant de mettre à jour les graphiques existants plutôt que de les remplacer. Par exemple, dans l’exemple qui suit, la mise à jour du graphique plutôt que son remplacement permet de mieux suivre l’évolution du rang de chacune des marques représentées.</p>
<iframe width="100%" height="726" frameborder="0" src="https://observablehq.com/embed/@d3/bar-chart-race?cells=viewof+replay%2Cchart">
</iframe>
<p>On aura généralement recours à D3.js (voir le notebook indiqué ci-dessous pour une introduction à D3.js) pour réaliser ce type de graphiques animés, mais il reste possible de combiner Plot et D3.js pour obtenir un résultat similaire (comme dans le <a href="https://observablehq.com/@fil/plot-animate-a-bar-chart/2">notebook “Plot: Animate a bar chart (v2)” de <span class="citation" data-cites="Fil">@Fil</span></a>).</p>
<p>Voir aussi :</p>
<ul>
<li><a href="https://observablehq.com/@mkfreeman/plot-animation">le notebook “Plot Animation” par <span class="citation" data-cites="mkfreeman">@mkfreeman</span></a>.</li>
<li><a href="https://observablehq.com/@recifs/plot-fade-in-bar-chart">le notebook “Plot: Fade-in bar chart” par <span class="citation" data-cites="Fil">@Fil</span></a>.</li>
</ul>
</section>
</section>
<section id="pour-aller-plus-loin---d3.js" class="level2">
<h2 class="anchored" data-anchor-id="pour-aller-plus-loin---d3.js">Pour aller plus loin - D3.js</h2>
<p>Certains types de graphiques peuvent ne pas être réalisables avec Plot. Dans ce cas, il est possible de recourir à D3.js. Cette bibliothèque JavaScript permet de créer des graphiques complexes et personnalisés, mais elle est également plus complexe à prendre en main que Plot.</p>
<p>Voir le notebook <a href="https://observablehq.com/@sd-progwebdataviz/faire-des-graphiques-avec-d3-js">Faire des graphiques avec D3.js</a>.</p>
<p>En fonction du temps restant, essayez d’intégrer un graphique réaliser avec D3.js dans la page HTML que vous avez créée pour cet exercice (par exemple un diagramme circulaire).</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Correction : <a href="./data/TP8.zip">TP8.zip</a></p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>